<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whale Tracker & Trading Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">üêã Whale Tracker & Trading Bot</span>
            <div class="d-flex align-items-center">
                <span id="market-state" class="badge bg-success me-3">NORMAL</span>
                <span class="navbar-text" id="bot-uptime"></span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Whale Alerts & Risk Level -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Whale Activity Monitor</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h6>Whale Alerts (1h)</h6>
                                <h2 id="whale-alerts-1h">-</h2>
                            </div>
                            <div class="col-6">
                                <h6>Whale Alerts (24h)</h6>
                                <h2 id="whale-alerts-24h">-</h2>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6>Latest Whale Alert</h6>
                            <p id="latest-whale-alert" class="text-muted">No recent alerts</p>
                        </div>
                        <div class="mt-3">
                            <h6>Risk Level</h6>
                            <div id="risk-level" class="alert alert-warning">Medium</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market Data -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Market Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="market-data">
                            <!-- Market data will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio & Performance -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Portfolio & Performance</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6>Holdings</h6>
                                <div id="portfolio" class="table-responsive">
                                    <!-- Portfolio data will be inserted here -->
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4">
                                <h6>Trades Today</h6>
                                <h3 id="trades-today">-</h3>
                            </div>
                            <div class="col-4">
                                <h6>Win Rate</h6>
                                <h3 id="win-rate">-</h3>
                            </div>
                            <div class="col-4">
                                <h6>Profit Today</h6>
                                <h3 id="profit-today">-</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">System Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <h6>Trading Status</h6>
                                <div id="trading-status" class="alert alert-success">Active</div>
                            </div>
                            <div class="col-6">
                                <h6>API Status</h6>
                                <div id="api-status" class="alert alert-success">Operational</div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6>Recent Errors</h6>
                            <ul id="error-logs" class="list-group">
                                <!-- Error logs will be inserted here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ISO20022 Holdings -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">ISO20022 Holdings</h5>
                        <span class="badge bg-primary">HODL MODE</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="iso20022-holdings">
                                <thead>
                                    <tr>
                                        <th>Coin</th>
                                        <th>Amount</th>
                                        <th>Value (USDT)</th>
                                        <th>DCA Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- ISO20022 holdings will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <h6>Total ISO20022 Value</h6>
                            <h3 id="total-iso20022-value">$0.00</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Meme Coin Trading -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Meme Coin Trading</h5>
                        <div>
                            <span id="meme-trading-status" class="badge bg-success">ENABLED</span>
                            <button id="toggle-meme-trading" class="btn btn-sm btn-outline-primary ms-2">Toggle</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="meme-holdings">
                                <thead>
                                    <tr>
                                        <th>Coin</th>
                                        <th>Amount</th>
                                        <th>Entry Price</th>
                                        <th>Current Price</th>
                                        <th>P/L %</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Meme coin holdings will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <h6>Total Meme Coin Value</h6>
                            <h3 id="total-meme-value">$0.00</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market Protection Status -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Market Protection Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h6>BTC Reference Price</h6>
                                <h4 id="btc-reference-price">$0.00</h4>
                            </div>
                            <div class="col-6">
                                <h6>Current Drop</h6>
                                <h4 id="btc-drop-percentage">0.00%</h4>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6>Protection Rules</h6>
                            <ul class="list-group" id="protection-rules">
                                <!-- Protection rules will be inserted here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cold Storage Transfers -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Cold Storage Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-4">
                                <h6>ISO20022 in Cold Storage</h6>
                                <h4 id="cold-storage-iso20022">$0.00</h4>
                            </div>
                            <div class="col-4">
                                <h6>Stablecoin Reserve</h6>
                                <h4 id="cold-storage-stable">$0.00</h4>
                            </div>
                            <div class="col-4">
                                <h6>Pending Transfers</h6>
                                <h4 id="pending-transfers">0</h4>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6>Recent Transfers</h6>
                            <div class="table-responsive">
                                <table class="table" id="recent-transfers">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Asset</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Recent transfers will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let lastPrices = {
            'BTC/USDT': null,
            'ETH/USDT': null
        };
        let isFirstLoad = true;
        let updateInProgress = false;

        function setLoadingState(loading) {
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                if (loading) {
                    card.classList.add('loading');
                } else {
                    card.classList.remove('loading');
                }
            });
        }

        function updatePrice(elementId, newPrice, oldPrice) {
            const el = document.getElementById(elementId);
            if (!el) return;

            // Only update if we have a valid price
            if (newPrice && newPrice > 0) {
                // Add animation class if price changed and not first load
                if (oldPrice !== null && newPrice !== oldPrice && !isFirstLoad) {
                    el.classList.remove('highlight');
                    void el.offsetWidth; // Trigger reflow
                    el.classList.add('highlight');
                }
                el.textContent = `$${newPrice.toLocaleString()}`;
            }
        }

        function updateMarketState(state, dropPercentage) {
            const stateEl = document.getElementById('market-state');
            const oldClass = stateEl.className;
            let newClass = 'badge ';
            
            switch(state) {
                case 'NORMAL':
                    newClass += 'bg-success';
                    break;
                case 'CAUTION':
                    newClass += 'bg-warning text-dark';
                    break;
                case 'WARNING':
                    newClass += 'bg-orange';
                    break;
                case 'DANGER':
                    newClass += 'bg-danger';
                    break;
            }
            
            stateEl.className = newClass;
            stateEl.textContent = state;
            
            // Update drop percentage
            document.getElementById('btc-drop-percentage').textContent = 
                `${dropPercentage.toFixed(2)}%`;
        }

        function updateISO20022Holdings(holdings) {
            const tbody = document.querySelector('#iso20022-holdings tbody');
            tbody.innerHTML = holdings.map(coin => `
                <tr>
                    <td>${coin.symbol}</td>
                    <td>${coin.amount}</td>
                    <td>$${coin.value.toLocaleString()}</td>
                    <td>
                        <span class="badge ${coin.dca_active ? 'bg-success' : 'bg-secondary'}">
                            ${coin.dca_active ? 'DCA Active' : 'Waiting'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updateMemeHoldings(holdings) {
            const tbody = document.querySelector('#meme-holdings tbody');
            tbody.innerHTML = holdings.map(coin => `
                <tr>
                    <td>${coin.symbol}</td>
                    <td>${coin.amount}</td>
                    <td>$${coin.entry_price.toLocaleString()}</td>
                    <td>$${coin.current_price.toLocaleString()}</td>
                    <td class="${coin.pl_percentage >= 0 ? 'text-success' : 'text-danger'}">
                        ${coin.pl_percentage.toFixed(2)}%
                    </td>
                    <td>
                        ${coin.action ? `
                            <span class="badge bg-warning">${coin.action}</span>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        async function updateDashboard() {
            if (updateInProgress) return;
            updateInProgress = true;

            try {
                if (isFirstLoad) {
                    setLoadingState(true);
                }

                const response = await fetch('/api/status');
                const data = await response.json();

                if (data.error) {
                    console.error('API Error:', data.message);
                    return;
                }

                // Update Whale Alerts
                document.getElementById('whale-alerts-1h').textContent = data.whale_alerts['1h'];
                document.getElementById('whale-alerts-24h').textContent = data.whale_alerts['24h'];
                if (data.whale_alerts.latest) {
                    document.getElementById('latest-whale-alert').textContent = 
                        `Wallet ${data.whale_alerts.latest.wallet.substring(0, 8)}... moved ${data.whale_alerts.latest.amount} BTC`;
                }

                // Update Risk Level
                const riskEl = document.getElementById('risk-level');
                riskEl.textContent = data.risk_level;
                riskEl.className = `alert alert-${data.risk_level === 'High' ? 'danger' : 
                                                data.risk_level === 'Medium' ? 'warning' : 'success'}`;

                // Update Market Data with price transition
                if (data.market_data) {
                    const marketHtml = Object.entries(data.market_data).map(([pair, info]) => {
                        // Store new price for comparison
                        const oldPrice = lastPrices[pair];
                        lastPrices[pair] = info.price;

                        return `
                            <div class="col-6 mb-3">
                                <h6>${pair}</h6>
                                <h4 id="price-${pair.replace('/', '-')}" class="${!isFirstLoad && oldPrice !== null && info.price !== oldPrice ? 'highlight' : ''}">
                                    $${info.price.toLocaleString()}
                                </h4>
                                <span class="badge ${info['24h_change'] >= 0 ? 'bg-success' : 'bg-danger'}">
                                    ${info['24h_change'].toFixed(2)}%
                                </span>
                                <small class="text-muted d-block">Vol: $${info.volume.toLocaleString()}</small>
                            </div>
                        `;
                    }).join('');
                    document.getElementById('market-data').innerHTML = marketHtml;
                }

                // Update Portfolio
                const portfolioHtml = `
                    <table class="table table-sm">
                        <tbody>
                            ${Object.entries(data.portfolio).map(([coin, amount]) => `
                                <tr>
                                    <td>${coin}</td>
                                    <td class="text-end">${amount}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('portfolio').innerHTML = portfolioHtml;

                // Update Performance
                document.getElementById('trades-today').textContent = data.performance.trades_today;
                document.getElementById('win-rate').textContent = `${(data.performance.win_rate * 100).toFixed(1)}%`;
                document.getElementById('profit-today').textContent = 
                    `$${data.performance.profit_today >= 0 ? '+' : ''}${data.performance.profit_today.toLocaleString()}`;

                // Update System Status
                document.getElementById('bot-uptime').textContent = `Uptime: ${data.system.uptime}`;
                
                const tradingStatusEl = document.getElementById('trading-status');
                tradingStatusEl.textContent = data.trading_status;
                tradingStatusEl.className = `alert alert-${data.trading_status === 'Active' ? 'success' : 'warning'}`;

                const apiStatusEl = document.getElementById('api-status');
                apiStatusEl.textContent = data.system.api_status;
                apiStatusEl.className = `alert alert-${data.system.api_status === 'Operational' ? 'success' : 'danger'}`;

                // Update Error Logs
                const errorLogsHtml = data.system.errors.map(error => 
                    `<li class="list-group-item ${error === 'No errors' ? 'text-success' : 'text-danger'}">${error}</li>`
                ).join('');
                document.getElementById('error-logs').innerHTML = errorLogsHtml;

                // Update market state
                updateMarketState(data.market_state, data.btc_drop_percentage);

                // Update holdings
                updateISO20022Holdings(data.iso20022_holdings);
                updateMemeHoldings(data.meme_holdings);

                // Update totals
                document.getElementById('total-iso20022-value').textContent = 
                    `$${data.totals.iso20022.toLocaleString()}`;
                document.getElementById('total-meme-value').textContent = 
                    `$${data.totals.meme.toLocaleString()}`;

                // Update cold storage
                document.getElementById('cold-storage-iso20022').textContent = 
                    `$${data.cold_storage.iso20022.toLocaleString()}`;
                document.getElementById('cold-storage-stable').textContent = 
                    `$${data.cold_storage.stablecoin.toLocaleString()}`;
                document.getElementById('pending-transfers').textContent = 
                    data.cold_storage.pending_transfers;

                // Update protection rules
                const rulesHtml = data.protection_rules.map(rule => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${rule.description}
                        <span class="badge ${rule.active ? 'bg-danger' : 'bg-secondary'}">
                            ${rule.active ? 'Active' : 'Inactive'}
                        </span>
                    </li>
                `).join('');
                document.getElementById('protection-rules').innerHTML = rulesHtml;

                // Update recent transfers
                const transfersHtml = data.recent_transfers.map(transfer => `
                    <tr>
                        <td>${new Date(transfer.time).toLocaleString()}</td>
                        <td>${transfer.asset}</td>
                        <td>${transfer.amount}</td>
                        <td>
                            <span class="badge bg-${transfer.status === 'Completed' ? 'success' : 'warning'}">
                                ${transfer.status}
                            </span>
                        </td>
                    </tr>
                `).join('');
                document.querySelector('#recent-transfers tbody').innerHTML = transfersHtml;

            } catch (error) {
                console.error('Error updating dashboard:', error);
            } finally {
                if (isFirstLoad) {
                    setLoadingState(false);
                    isFirstLoad = false;
                }
                updateInProgress = false;
            }
        }

        // Toggle meme trading
        document.getElementById('toggle-meme-trading').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/toggle-meme-trading', { method: 'POST' });
                const data = await response.json();
                
                const statusEl = document.getElementById('meme-trading-status');
                statusEl.textContent = data.enabled ? 'ENABLED' : 'DISABLED';
                statusEl.className = `badge ${data.enabled ? 'bg-success' : 'bg-danger'}`;
            } catch (error) {
                console.error('Error toggling meme trading:', error);
            }
        });

        // Update immediately and then every 5 seconds
        updateDashboard();
        setInterval(updateDashboard, 5000);
    </script>
</body>
</html> 